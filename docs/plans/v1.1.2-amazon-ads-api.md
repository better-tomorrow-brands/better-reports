## Goal

Add a daily cron job that pulls the `spCampaigns` report from the Amazon Advertising API v3 and stores it in the database. Nothing else — no frontend, no ROAS calc, no other report types. Get data in, then we test.

## 1. Settings (Amazon Ads API credentials)

The existing settings page has an "Amazon" tab for **Amazon SP-API** credentials (`client_id`, `client_secret`, `refresh_token`, `marketplace_id`). These are stored encrypted under the key `"amazon"` in the settings table.

Add a second section on the same tab for **Amazon Ads API** credentials. Store under key `"amazon_ads"`.

### Interface: `AmazonAdsSettings`

```ts
interface AmazonAdsSettings {
  client_id: string;       // amzn1.application-oa2-client.xxxxx
  client_secret: string;
  refresh_token: string;
  profile_id: string;      // e.g. "366822873177837"
}
```

### Changes needed:

**`src/lib/settings.ts`** — add `getAmazonAdsSettings(orgId)` and `saveAmazonAdsSettings(orgId, settings)`, same pattern as existing `getAmazonSettings`/`saveAmazonSettings`.

**`src/app/api/settings/route.ts`** — GET: fetch and mask `amazon_ads` alongside existing keys. POST: handle `body.amazon_ads` with same masked-value restoration pattern.

**`src/app/settings/page.tsx`** — on the Amazon tab, add a divider and second section:
- Heading: "Amazon SP-API" (existing fields)
- Divider
- Heading: "Amazon Ads API" (new fields: client_id, client_secret, refresh_token, profile_id)
- Same `LockedInput` pattern, separate form state, separate save/test buttons

**`src/app/api/test/amazon-ads/route.ts`** (new) — test endpoint that exchanges refresh token for an access token and returns success/failure. Called from the "Test Connection" button.

## 2. Database Changes

### Table: `amazon_sp_ads`

One row per campaign per day per org. Upsert key: `(org_id, date, campaign_id)`.

**Columns (store everything the API returns):**

Dimensions: `org_id`, `date`, `campaign_id`, `campaign_name`, `campaign_status`, `campaign_budget_amount`, `campaign_budget_type`, `campaign_budget_currency_code`, `campaign_rule_based_budget_amount`, `portfolio_id`, `start_date`, `end_date`

Metrics: `impressions`, `clicks`, `cost`, `cost_per_click`, `click_through_rate`, `sales_1d`, `sales_7d`, `sales_14d`, `sales_30d`, `purchases_1d`, `purchases_7d`, `purchases_14d`, `purchases_30d`, `units_sold_clicks_1d`, `units_sold_clicks_7d`, `units_sold_clicks_14d`, `units_sold_clicks_30d`, `purchase_click_rate_1d`, `purchase_click_rate_7d`, `purchase_click_rate_14d`, `purchase_click_rate_30d`, `acos_clicks_7d`, `acos_clicks_14d`, `roas_clicks_7d`, `roas_clicks_14d`, `new_to_brand_purchases_14d`, `new_to_brand_sales_14d`, `new_to_brand_units_sold_14d`, `new_to_brand_purchases_percentage_14d`, `new_to_brand_sales_percentage_14d`, `new_to_brand_units_sold_percentage_14d`, `add_to_cart`, `add_to_cart_rate`, `ecp_add_to_cart`, `impressions_1y`, `clicks_1y`, `spend_1y`, `cost_per_click_1y`

Plus: `created_at`, `updated_at` (timestamps for tracking upserts)

Note: API returns camelCase (`campaignId`, `sales14d`). Map to snake_case for DB columns.

### Table: `amazon_ads_pending_reports`

Tracks report requests between the two cron phases.

Columns: `id`, `org_id`, `report_id` (Amazon's ID), `report_date` (the lookback date), `status` (`pending` | `completed` | `failed`), `created_at`

Cleaned up after successful collection.

## 3. Auth Helper

### `lib/amazon-ads.ts`

Load credentials from settings:

```ts
const settings = await getAmazonAdsSettings(orgId);
```

Exchange refresh token for access token:

```
POST https://api.amazon.co.uk/auth/o2/token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&refresh_token={settings.refresh_token}
&client_id={settings.client_id}
&client_secret={settings.client_secret}
```

Returns `{ access_token, expires_in }`. Cache for the duration of the cron run (1 hour lifetime).

Every Ads API request needs these 3 headers:

```
Authorization: Bearer {access_token}
Amazon-Advertising-API-ClientId: {settings.client_id}
Amazon-Advertising-API-Scope: {settings.profile_id}
```

## 4. Cron Jobs (two-phase split)

Amazon Ads async reports can take minutes to generate — too long for a single Vercel function (300s max). Split into request and collect phases.

### Phase 1: `/api/cron/amazon-ads-request`

**Vercel cron:** Daily at 09:00 UTC

**Flow:**

1. Get access token (via auth helper)
2. Create 5 report requests in parallel (one per lookback date)
3. Store each `reportId` in `amazon_ads_pending_reports` with status `pending`
4. Log to `sync_logs`
5. Return

**Report request body:**

```
POST https://advertising-api-eu.amazon.com/reporting/reports
Content-Type: application/vnd.createasyncreportrequest.v3+json

{
  "name": "spCampaigns {date}",
  "startDate": "{date}",
  "endDate": "{date}",
  "configuration": {
    "adProduct": "SPONSORED_PRODUCTS",
    "groupBy": ["campaign"],
    "columns": [
      "date", "campaignId", "campaignName", "campaignStatus",
      "campaignBudgetAmount", "campaignBudgetType", "campaignBudgetCurrencyCode",
      "campaignRuleBasedBudgetAmount", "portfolioId", "startDate", "endDate",
      "impressions", "clicks", "cost", "costPerClick", "clickThroughRate",
      "sales1d", "sales7d", "sales14d", "sales30d",
      "purchases1d", "purchases7d", "purchases14d", "purchases30d",
      "unitsSoldClicks1d", "unitsSoldClicks7d", "unitsSoldClicks14d", "unitsSoldClicks30d",
      "purchaseClickRate1d", "purchaseClickRate7d", "purchaseClickRate14d", "purchaseClickRate30d",
      "acosClicks7d", "acosClicks14d", "roasClicks7d", "roasClicks14d",
      "newToBrandPurchases14d", "newToBrandSales14d", "newToBrandUnitsSold14d",
      "newToBrandPurchasesPercentage14d", "newToBrandSalesPercentage14d", "newToBrandUnitsSoldPercentage14d",
      "addToCart", "addToCartRate", "eCPAddToCart",
      "impressions1y", "clicks1y", "spend1y", "costPerClick1y"
    ],
    "reportTypeId": "spCampaigns",
    "timeUnit": "DAILY",
    "format": "GZIP_JSON"
  }
}
```

### Phase 2: `/api/cron/amazon-ads-collect`

**Vercel cron:** Daily at 09:30 UTC

**Flow:**

1. Query `amazon_ads_pending_reports` for rows with status `pending`
2. Get access token
3. For each pending report:
   a. Poll: `GET https://advertising-api-eu.amazon.com/reporting/reports/{reportId}`
   b. If `COMPLETED`: download gzipped JSON from `url` field, parse rows, upsert into `amazon_sp_ads`, mark row `completed`
   c. If `FAILURE`: log error, mark row `failed`
   d. If still processing: skip (will be picked up on next run or retry)
4. Delete completed/failed rows older than 24h
5. Log to `sync_logs`

### Lookback dates

Amazon restates conversion data at 1, 7, and 28 days. Each run requests:

- day-1 (yesterday)
- day-3 (post click-validation)
- day-7 (first restatement)
- day-14 (mid restatement)
- day-30 (final restatement)

That's 5 report requests per run. Created in parallel (phase 1), collected sequentially (phase 2).

### Error handling

- 429 (rate limit): exponential backoff
- Report status `FAILURE`: log error, skip that date, continue others
- Token refresh failure: abort run, log to `sync_logs`
- Collect finds reports still processing: leave as `pending`, picked up next time

### `vercel.json` additions

```json
{
  "path": "/api/cron/amazon-ads-request?orgId=1",
  "schedule": "0 9 * * *"
},
{
  "path": "/api/cron/amazon-ads-collect?orgId=1",
  "schedule": "30 9 * * *"
}
```

## 5. Files Changed / Created

| File | Change |
|------|--------|
| `src/lib/settings.ts` | Add `AmazonAdsSettings` interface, `getAmazonAdsSettings`, `saveAmazonAdsSettings` |
| `src/app/api/settings/route.ts` | GET/POST: handle `amazon_ads` key alongside existing keys |
| `src/app/settings/page.tsx` | Add "Amazon Ads API" section below existing "Amazon SP-API" section |
| `src/app/api/test/amazon-ads/route.ts` | **New** — test token exchange |
| `src/lib/db/schema.ts` | Add `amazonSpAds` and `amazonAdsPendingReports` tables |
| `src/lib/amazon-ads.ts` | **New** — auth helper, report create/poll/download, upsert logic |
| `src/app/api/cron/amazon-ads-request/route.ts` | **New** — phase 1 cron |
| `src/app/api/cron/amazon-ads-collect/route.ts` | **New** — phase 2 cron |
| `src/proxy.ts` | Add cron routes to public list |
| `vercel.json` | Add two cron schedules |

## That's it

Once data is flowing into **`amazon_sp_ads`**, we stop and verify the data looks correct before building anything on top of it.
