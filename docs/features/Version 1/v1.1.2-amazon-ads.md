# Amazon Ads Integration (v1.1.2)

Automated daily sync of Sponsored Products campaign data from the Amazon Advertising API. Data flows through a two-phase cron system (request → collect), is stored per-campaign in Neon, and surfaces as ad spend/revenue metrics on the Amazon reports chart alongside calculated fees and estimated payout.

## How It Works

1. Settings page stores Amazon Ads OAuth credentials (client ID, client secret, refresh token, profile ID) as encrypted JSON in the `settings` table under key `"amazon_ads"`
2. Daily cron **request** job (09:00 UTC) exchanges the refresh token for an access token, creates Sponsored Products campaign reports for lookback dates (1, 3, 7, 14, 30 days ago), and stores report IDs in the `amazon_ads_pending_reports` bridge table
3. Daily cron **collect** job (09:30 UTC) polls each pending report — downloads and upserts completed ones, marks failures, leaves still-processing reports for the next run
4. Manual sync via the Reports page runs both phases inline (request → poll → collect) within a single 5-minute request
5. Reports API aggregates ad spend and ad revenue (14-day attribution) by date and merges with sales/traffic data for charting
6. A backfill endpoint supports historical data import up to 60 days

## Two-Phase Cron System

Amazon Ads reports are asynchronous — a report request returns a `reportId`, and the report takes time to generate (typically 1–5 minutes). The two-phase pattern decouples creation from retrieval:

### Phase 1: Request (09:00 UTC)

```
Cron trigger
    │
    ├── Get access token (refresh token → LWA endpoint)
    │
    ├── For each lookback date (1d, 3d, 7d, 14d, 30d ago):
    │   ├── POST to Amazon Advertising API → reportId
    │   └── INSERT into amazon_ads_pending_reports (status: "pending")
    │
    └── Log summary to sync_logs
```

**Why multiple lookback dates?** Amazon's attribution model evolves — a sale attributed to an ad click may not appear until 14 or 30 days later. Re-fetching recent dates captures these late attributions.

### Phase 2: Collect (09:30 UTC)

```
Cron trigger
    │
    ├── Get access token
    ├── SELECT pending reports from amazon_ads_pending_reports
    │
    ├── For each pending report:
    │   ├── GET report status
    │   ├── COMPLETED → download GZIP JSON → upsert to amazon_sp_ads → mark completed
    │   ├── FAILURE → mark failed
    │   ├── PROCESSING → leave pending (retry next run)
    │   └── RATE_LIMITED → stop processing, back off
    │
    ├── Cleanup reports older than 24 hours
    └── Log summary to sync_logs
```

## Data Flow

```
Settings Page → Encrypted DB (settings table, key="amazon_ads")
                    │
Cron Request ──────▶ Amazon Advertising API (EU) → Pending Reports Table
                    │
Cron Collect ──────▶ Poll Status → Download GZIP → Decompress → amazon_sp_ads Table
                    │
Reports API ───────▶ Aggregate (cost, sales14d) by date → Merge with sales/traffic
                    │
AmazonChart ───────▶ Ad Spend line, Revenue vs Expenses chart, ROAS scorecard
```

## Authentication

Amazon Ads uses Login with Amazon (LWA) OAuth 2.0, separate from SP-API credentials:

- **Token endpoint:** `https://api.amazon.co.uk/auth/o2/token` (UK)
- **Reporting endpoint:** `https://advertising-api-eu.amazon.com/reporting/reports` (EU)
- **Grant type:** `refresh_token`
- **Required headers:** `Amazon-Advertising-API-ClientId`, `Amazon-Advertising-API-Scope` (profile ID)

The access token is short-lived and obtained fresh on each cron run. The refresh token is long-lived and stored encrypted in the database.

## Report Configuration

Each report request targets Sponsored Products campaigns with the following configuration:

| Setting | Value |
|---|---|
| Ad product | `SPONSORED_PRODUCTS` |
| Report type | `spCampaigns` |
| Group by | `campaign` |
| Time unit | `DAILY` |
| Format | `GZIP_JSON` |
| Lookback window | `TWENTY_EIGHT_DAYS` |

### Metrics Collected (69 columns)

**Dimensions:** campaignId, campaignName, campaignStatus, budget (amount, type, currency, rule-based), bidding strategy, applicable budget rule

**Core:** impressions, clicks, cost, spend, CPC, CTR, top-of-search impression share

**Sales (4 attribution windows x 2):** sales (1d/7d/14d/30d), attributed sales same-SKU (1d/7d/14d/30d)

**Purchases (4 windows x 2):** purchases (1d/7d/14d/30d), purchases same-SKU (1d/7d/14d/30d)

**Units Sold (4 windows x 2):** units sold clicks (1d/7d/14d/30d), units sold same-SKU (1d/7d/14d/30d)

**Efficiency:** ACOS (14d), ROAS (14d)

**Other:** add to list

## Cron Schedules

| Schedule | Endpoint | Duration | Purpose |
|---|---|---|---|
| `0 9 * * *` (daily 09:00 UTC) | `/api/cron/amazon-ads-request?orgId=1` | 60s max | Create report requests |
| `30 9 * * *` (daily 09:30 UTC) | `/api/cron/amazon-ads-collect?orgId=1` | 300s max | Collect completed reports |

Both endpoints require `Authorization: Bearer <CRON_SECRET>` in production.

## Reports Integration

### API Route (`/api/reports/amazon`)

Ad spend data is queried separately from sales/traffic to avoid join inflation:

```
Query 1: amazon_sales_traffic LEFT JOIN products
    → revenue, units, sessions, fbaFees, referralFees (calculated)

Query 2: amazon_sp_ads
    → adSpend (SUM of cost), adRevenue (SUM of sales14d)

Merge on date → estimatedPayout = revenue - adSpend - fbaFees - referralFees
```

FBA fees and referral fees are calculated in real-time from the `products` table (per-unit fbaFee and per-sale referralPercent) rather than from financial events, which have a reporting lag.

### Chart Display

**Summary chart (top):**
- Revenue bar (amber)
- Est. Payout line (deep orange, `#f97316`, dots on)
- Ad Spend line (obsidian, `#2d2d2d`, dots on)
- Units Ordered, Sessions (hidden by default)

**Revenue vs Expenses chart (bottom):**
- Revenue line (orange)
- Stacked expense bars: Ad Spend (`#2d2d2d`), FBA Fees (`#f59e0b`), Referral Fees (`#6366f1`)

**Scorecards:**
- Ad Revenue, Ad Spend, ROAS (adRevenue / adSpend), Est. Payout

## Database Schema

### `amazon_sp_ads` table

| Column | Type | Details |
|---|---|---|
| `id` | serial | Primary key |
| `org_id` | integer | FK → `organizations.id` |
| `date` | date | Report date |
| `campaign_id` | text | Amazon campaign ID (NOT NULL) |
| `campaign_name` | text | Campaign display name |
| `campaign_status` | text | ENABLED / PAUSED / ARCHIVED |
| `campaign_budget_amount` | real | Daily budget |
| `campaign_budget_type` | text | DAILY / LIFETIME |
| `campaign_budget_currency_code` | text | e.g. GBP |
| `campaign_bidding_strategy` | text | e.g. LEGACY_FOR_SALES |
| `impressions` | integer | Default 0 |
| `clicks` | integer | Default 0 |
| `cost` | real | Default 0 |
| `spend` | real | Spend amount |
| `cost_per_click` | real | CPC |
| `click_through_rate` | real | CTR |
| `sales_1d` / `7d` / `14d` / `30d` | real | Sales by attribution window |
| `purchases_1d` / `7d` / `14d` / `30d` | integer | Purchases by window |
| `units_sold_clicks_1d` / `7d` / `14d` / `30d` | integer | Units sold by window |
| `attributed_sales_same_sku_*` | real | Same-SKU sales (4 windows) |
| `purchases_same_sku_*` | integer | Same-SKU purchases (4 windows) |
| `units_sold_same_sku_*` | integer | Same-SKU units (4 windows) |
| `acos_clicks_14d` | real | ACOS (14-day) |
| `roas_clicks_14d` | real | ROAS (14-day) |
| `add_to_list` | integer | Add-to-list actions |
| `created_at` | timestamptz | Default `now()` |
| `updated_at` | timestamptz | Default `now()` |

**Unique index:** `(org_id, date, campaign_id)` — used for upsert conflict resolution.

### `amazon_ads_pending_reports` table

| Column | Type | Details |
|---|---|---|
| `id` | serial | Primary key |
| `org_id` | integer | FK → `organizations.id` |
| `report_id` | text | Amazon report ID (NOT NULL) |
| `report_date` | date | Date the report covers |
| `status` | text | `pending` / `completed` / `failed` (default: `pending`) |
| `created_at` | timestamptz | Default `now()` |

Reports older than 24 hours are automatically cleaned up by the collect job.

## Settings

### Settings Page Fields (Amazon Ads API section)

| Field | Description |
|---|---|
| Client ID | Amazon Ads developer app credentials |
| Client Secret | Login with Amazon (LWA) client secret |
| Refresh Token | OAuth refresh token (starts with `Atzr\|`) |
| Profile ID | Amazon Advertising profile ID (numeric) |

These are separate from the SP-API credentials used for sales/traffic data.

### Test Connection

The Settings page has a "Test Connection" button that calls `/api/test/amazon-ads`. This exchanges the refresh token for an access token and returns success with the token expiry time, or an error message.

## Backfill

### Endpoint

```
GET /api/backfill/amazon-ads?orgId=1&days=60&batch=5
```

| Param | Default | Description |
|---|---|---|
| `orgId` | required | Organization ID |
| `days` | 60 | Number of days to backfill (excluding today) |
| `batch` | 5 | Reports per batch (parallel requests) |

### Process

1. Generates date list for the last N days
2. Skips dates already present in `amazon_sp_ads`
3. Processes in batches — each batch creates report requests in parallel, polls until complete (max 3 min per batch), downloads and upserts
4. 5-second pause between batches to avoid rate limits
5. Hard deadline of 270 seconds (30s before the 300s maxDuration)
6. Returns per-date results: `success` / `error` / `timeout` / `skipped`

### Response

```json
{
  "success": true,
  "summary": {
    "total": 60,
    "fetched": 45,
    "rows": 180,
    "skipped": 12,
    "errors": 1,
    "timeouts": 2
  },
  "results": [
    { "date": "2026-01-15", "status": "success", "rows": 4 },
    { "date": "2026-01-16", "status": "skipped" },
    ...
  ]
}
```

## Manual Sync

The Reports page "Sync Data" button triggers `POST /api/reports/sync`, which runs Amazon Ads sync inline alongside other sources (Amazon Sales, Facebook, PostHog). The Amazon Ads sync:

1. Gets settings and access token
2. Creates reports for all lookback dates in parallel
3. Polls up to 3 minutes total (15s intervals)
4. Downloads completed reports and upserts to `amazon_sp_ads`
5. Reports still processing after timeout are logged as errors

## Environment Variables

| Variable | Purpose |
|---|---|
| `CRON_SECRET` | Auth token for cron endpoints |
| `CONFIG_ENCRYPTION_KEY` | AES-256-GCM key for settings encryption |
| `DATABASE_URL` | Neon connection string |

Amazon Ads credentials (client_id, client_secret, refresh_token, profile_id) are stored encrypted in the database, not as environment variables.

## Local Development

### Test connection
```
GET http://localhost:3000/api/test/amazon-ads
```
(Requires X-Org-Id header)

### Trigger cron jobs manually
```
GET http://localhost:3000/api/cron/amazon-ads-request?orgId=1
GET http://localhost:3000/api/cron/amazon-ads-collect?orgId=1
```

### Backfill historical data
```
GET http://localhost:3000/api/backfill/amazon-ads?orgId=1&days=60
```

### Quick test (5 days only)
```
GET http://localhost:3000/api/backfill/amazon-ads?orgId=1&days=5
```

## Key Files

| File | Purpose |
|---|---|
| `src/lib/amazon-ads.ts` | Core library — auth, report CRUD, download, upsert, pending reports |
| `src/lib/settings.ts` | `getAmazonAdsSettings()`, `saveAmazonAdsSettings()` |
| `src/lib/db/schema.ts` | Drizzle schema — `amazonSpAds`, `amazonAdsPendingReports` |
| `src/app/api/cron/amazon-ads-request/route.ts` | Phase 1 cron — create report requests |
| `src/app/api/cron/amazon-ads-collect/route.ts` | Phase 2 cron — collect completed reports |
| `src/app/api/backfill/amazon-ads/route.ts` | Historical data backfill |
| `src/app/api/reports/amazon/route.ts` | Reports API — aggregates ad spend with sales data |
| `src/app/api/reports/sync/route.ts` | Manual sync — runs Amazon Ads inline with other sources |
| `src/app/api/test/amazon-ads/route.ts` | Test connection endpoint |
| `src/components/reports/AmazonChart.tsx` | Chart component — ad spend line, expenses chart, ROAS scorecard |
| `src/app/settings/page.tsx` | Settings UI — Amazon Ads credentials section |
| `vercel.json` | Cron schedule configuration |
