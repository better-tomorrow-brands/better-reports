# v1.2.0 — Campaigns Drill-Down, Org Management, ShipBob, Meta Metrics, Nav Restructure

A large batch of features shipped since v1.1.3: full campaigns → ad sets → ads drill-down with thumbnails, an organization detail/management page, ShipBob inventory integration, extended Meta Ads metrics, per-org DB settings, multi-currency, Shopify CSV import, product sync, and a restructured navigation.

---

## Campaigns Drill-Down

### `/campaigns/[id]` — Ad Sets → Ads

Clicking a campaign row in `/campaigns` navigates to a dedicated drill-down page.

**Ad sets table**

All ad sets for the campaign are shown, aggregated over a configurable date range (default: last 30 days), ordered by spend descending.

Columns: Results (purchases), Reach, Frequency, Cost/Result, Amount Spent, Impressions, CPM, Link Clicks, Shop Clicks, CPC, CTR, Clicks, LP Views, Cost/LP View.

**Ad creatives inline expand**

Clicking an ad set row expands it inline to show its individual ads. Each ad shows:
- Thumbnail image (64×64, fetched via `/api/meta/ad-thumbnail`)
- Ad name
- Same full metric columns as the ad set

**Frequency aggregation**

Frequency is a per-day, per-ad figure. Summing it directly across rows would produce nonsense. It is computed as a weighted average: `SUM(frequency × impressions) / SUM(impressions)`.

### New DB Columns on `facebook_ads`

Four columns were added via migration `0020_lame_paibok.sql`:

| Column | Type | Source |
|---|---|---|
| `link_clicks` | integer | `inline_link_clicks` field in Meta API |
| `shop_clicks` | integer | `actions` where `action_type = initiate_checkout` |
| `landing_page_views` | integer | `actions` where `action_type = landing_page_view` |
| `cost_per_landing_page_view` | real | `cost_per_action_type` where `action_type = landing_page_view` |

### `/api/meta/ad-thumbnail`

`GET /api/meta/ad-thumbnail?adId=<id>`

Proxy endpoint that fetches `/{adId}?fields=creative{thumbnail_url,image_url}` from the Meta Graph API (v21.0) using the org's stored access token. Returns `{ thumbnailUrl: string | null }`. Never throws — returns null on any failure so missing thumbnails don't break the UI.

### API Routes Updated

**`/api/reports/facebook-adsets`** — now returns: `spend, impressions, reach, frequency, clicks, linkClicks, shopClicks, landingPageViews, purchases, purchaseValue, roas, ctr, cpc, cpm, costPerResult, costPerLandingPageView`

**`/api/reports/facebook-ad-creatives`** — same full metric set as adsets, plus `adId` for thumbnail lookup.

Both routes support filtering by `campaignId` (Meta campaign ID, preferred) with fallback to `utmCampaign`.

---

## Organization Detail Page

### `/organizations/[id]`

A dedicated page for managing a single organization. Org names in the `/organizations` list are now clickable links to this page.

**Sections:**
- **Name** — displays current name and slug; inline rename form
- **Members** — list of all members with email, name, role selector (user / admin), remove button; add member by email + role
- **Danger Zone** — delete the organization (with confirmation)

### `GET /api/organizations/[id]`

New endpoint added alongside the existing PATCH and DELETE. Returns `{ org }` for the given org ID. Requires super_admin platform role.

---

## ShipBob Integration

ShipBob is an optional 3PL integration gated by a `shipbobEnabled` flag returned from `GET /api/inventory`.

**When disabled (default):**
- ShipBob column hidden from inventory table and column picker
- ShipBob rows excluded from grouped inventory view
- ShipBob qty excluded from total quantity calculations
- ShipBob forecast and unit sales calculations excluded
- ShipBob field hidden in product edit modal

**When enabled:**
- Full ShipBob column and qty visible
- ShipBob qty included in total quantity and all calculations

**Settings:** A "Logistics" tab in Settings stores the ShipBob API key. The `/api/inventory` route checks for a stored key and returns `shipbobEnabled: true` if present.

---

## Navigation Restructure

### Dashboard at `/`

The home page (`/`) was previously a redirect to `/reports`. It is now a proper Dashboard page with the OverallChart (combined Shopify + Amazon + Facebook Ads revenue) as its primary content. Date range picker and groupBy controls render in the page header via the portal pattern.

### Sidebar Links

| Link | href | Visibility |
|---|---|---|
| Dashboard | `/` | All |
| Reports | `/reports` | All |
| Orders | `/orders` | Admin+ |
| Customers | `/customers` | Admin+ |
| Products | `/products` | Admin+ |
| Inventory | `/inventory` | Admin+ |
| Campaigns | `/campaigns` | Admin+ |
| Users | `/users` | Admin+ |
| Organizations | `/organizations` | Super admin |
| Settings | `/settings` | Admin+ |

**Products** links to `/products`, which redirects to `/inventory` (defaulting to the Products tab). This separation keeps the sidenav clean while reusing the existing inventory page infrastructure.

**Active state fix:** The Dashboard link (`/`) previously matched as active on every page because `pathname.startsWith("/")` is always true. Fixed with an explicit exact-match guard: `link.href === "/" ? pathname === "/" : pathname.startsWith(link.href + "/")`.

### Reports Page: Removed Tabs

The **Cashflow** and **Overall** tabs were removed from the Reports page. Overall moved to the Dashboard; Cashflow is hidden for now.

---

## Per-Org DB Settings (Credentials out of env vars)

All integration credentials (Shopify, Facebook Ads, Amazon, PostHog) moved from environment variables to per-org rows in the `settings` table. Each org configures its own credentials via the Settings page.

This enables true multi-tenant operation: different orgs can have different Shopify stores, different Meta ad accounts, different Amazon Seller accounts.

**Settings tabs:** Amazon, Shopify, Facebook Ads, PostHog, Lifecycle, Logistics (ShipBob).

---

## Multi-Currency

Orders now store the currency they were created in (captured from Shopify's `currencyCode`). A display currency preference per org controls how values are shown throughout the UI.

- Orders table: per-order currency displayed alongside amount
- Scorecards and charts: converted to display currency using stored exchange rates
- All hardcoded GBP/£ references replaced with dynamic currency formatting

---

## Shopify CSV Import

A historical data import tool for Shopify orders as a CSV file. Useful for clients migrating from another system or for orgs that hit the 60-day order history limit before switching to a Custom App connection.

**Route:** `POST /api/backfill/shopify-csv`

The import parses the Shopify-format CSV, maps columns to the `orders` schema, and upserts rows keyed on `(orgId, orderId)`.

---

## Product Sync from Shopify

Products are synced from the Shopify Admin API via `POST /api/products/sync`. The sync fetches all products with variants, upserts them into the `products` table, and marks products absent from the API response as inactive.

A **Sync** button in the inventory page toolbar triggers this on demand.

**Active/inactive lifecycle:** Products have a `status` field (`active` / `inactive`). The product list shows a status tag and supports filtering by status.

---

## Meta Campaign ID on Campaigns

Campaigns (`campaignsFcb`) now store a `metaCampaignId` column (the Meta campaign ID string, e.g. `120213...`). The campaign form in `/campaigns` includes this field.

When a campaign has a `metaCampaignId`, the adsets and creatives API routes use `eq(facebookAds.campaignId, metaCampaignId)` for filtering, which is exact and fast. Without it they fall back to `utmCampaign` string matching.

---

## PostHog Per-Org Settings

PostHog credentials (Project API Key, Personal API Key, Project ID) are stored per org in the `settings` table. The cron job iterates all orgs with PostHog configured and syncs sessions/traffic data for each.

---

## Bug Fixes

**Hardcoded org filter removed** — The Product Database tab had a hardcoded "Brand: Doogood" filter that auto-applied regardless of the selected org. All filters are now org-agnostic and reset when the org selector changes.

**Inventory page org reset** — Switching orgs now clears filters, products, inventory items, inventory date, and page state.

**Inventory table scroll** — Fixed a `min-h-0` constraint that prevented the inventory table from scrolling correctly within the flex layout.

**Shopify backfill status filter** — Shopify's GraphQL API does not accept `status:any`. Changed to `status:open OR status:closed OR status:cancelled`.

**Empty startDate param** — `URLSearchParams` was sending `startDate=` even when blank. Param is now conditionally added only when a value is present.

**Settings page not resetting on org switch** — Fixed so settings fields reload when the active org changes.
