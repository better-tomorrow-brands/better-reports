# v1.4.0 — AI Creative Generator & Subscriptions

## Summary

Minor release introducing AI-powered creative generation using Google Gemini, Shopify product image integration for ad creatives, Stripe subscription management and billing, and DigitalOcean Spaces for permanent asset storage.

---

## Changes

### AI Creative Generator (Google Gemini / "Nano Banana")

New `/creatives` page with AI-powered ad creative generation:

- **Image Generation** using Google Gemini 3.0 Pro Image Preview
  - Generates professional advertising photography from text prompts
  - Supports multiple variations (1-4 creatives per generation)
  - Context-aware generation using uploaded reference images
  - Product-aware generation using Shopify product images
  - Safety filters for inappropriate content (harassment, hate speech, adult content, dangerous content)

- **AI Ad Copy Generation** using Gemini 1.5 Pro
  - Generates complete ad copy packages: headline, primary text, description, call-to-action
  - Character limits optimized for social media ads (Facebook/Instagram best practices)
  - Non-blocking generation - image succeeds even if copy generation fails
  - Aligned with brand guidelines and campaign goals

- **Form Controls**
  - Campaign Goal (required) - primary creative direction
  - Target Action/CTA - desired user action
  - Ad Angle - creative approach (e.g., "luxury", "urgency", "social proof")
  - Product Selection - integrates with Shopify product catalog
  - Brand Guidelines - persistent brand voice and style guidance (up to 2000 chars)
  - Additional Instructions - custom per-generation context (up to 1000 chars)
  - Number of Variations - generate 1-4 creatives per request

- **Product Image Integration**
  - Select product from Shopify catalog dropdown
  - Toggle main product image and up to 10 gallery images
  - Main image selected by default when product chosen
  - Variant-specific images (prefers variant image over product featured image)
  - Upload additional context images (optional, separate from product images)

- **Creatives Gallery**
  - Grid display of all generated creatives
  - Full-resolution lightbox view
  - Expandable prompt details accordion showing all generation parameters
  - "Use This Prompt" button to reuse settings (restores all fields including image selection)
  - Remove button with database persistence
  - Loading skeleton for better perceived performance

- **Storage Options**
  - DigitalOcean Spaces integration for permanent cloud storage
  - Graceful fallback to base64 data URLs if Spaces not configured
  - CDN-optimized URLs when available

### Shopify Product Images

Extended Shopify product sync to fetch and store product images:

- New `product_images` table stores up to 10 images per product
- GraphQL query fetches `featuredImage` and `media.edges` (up to 10 images)
- Variant-specific images from `productVariants.edges.node.image`
- Automatic backfill during product sync webhook
- Images displayed as toggleable thumbnails in creative generator
- Supports both main image and gallery images

### Stripe Integration & Subscriptions

Complete subscription management system for SaaS billing:

- **Subscription Tiers**
  - Free (limited features)
  - Free Trial (early adopters, time-limited full access)
  - Starter ($49/mo)
  - Professional ($149/mo)
  - Enterprise (custom pricing)

- **Stripe Integration**
  - Customer Portal for subscription management
  - Webhook handlers for subscription events
  - Product ID mappings for all monthly tiers
  - Automatic customer creation on organization setup

- **UI/UX**
  - Plan badges in org switcher (sidebar)
  - Settings → Billing tab with "Manage Subscription" button
  - Dedicated `/subscriptions` page for super admins
  - Tier-based access control throughout app
  - Free trial display name: "Free Trial (Early Adopters)"

- **Admin Tools**
  - Super admin can view/edit all subscriptions at `/subscriptions`
  - Tier dropdown with starter/professional/enterprise options
  - Stripe Customer Portal link per organization

### DigitalOcean Spaces (Object Storage)

S3-compatible object storage for permanent asset hosting:

- **Storage Client** (`/src/lib/storage.ts`)
  - `uploadToSpaces()` - upload Buffer with content-type
  - `downloadAndUploadImage()` - fetch remote image and upload
  - `generateImageKey()` - unique key generation for images
  - `generateVideoKey()` - unique key generation for videos (future use)
  - `isSpacesConfigured()` - environment validation helper

- **Configuration**
  - Environment variables: `DO_SPACES_REGION`, `DO_SPACES_BUCKET`, `DO_SPACES_KEY`, `DO_SPACES_SECRET`, `DO_SPACES_ENDPOINT`
  - Optional CDN endpoint: `DO_SPACES_CDN_ENDPOINT`
  - Graceful degradation if not configured (uses base64 data URLs)

- **Usage**
  - AI-generated images uploaded to Spaces if configured
  - Public CDN URLs returned for fast delivery
  - Fallback to base64 inline images if upload fails or Spaces not configured
  - Organized by org: `creatives/{orgId}/{timestamp}-{random}.jpg`

### UX Improvements

- **Loading States**
  - Skeleton loading for creatives gallery (3 animated placeholder cards)
  - Non-blocking product loading (form available immediately)
  - "Loading products..." state in product dropdown
  - Form only blocks on critical org context loading

- **File Input**
  - Fixed "No file chosen" bug - removed conflicting `value=""` attribute
  - Key-based reset strategy for clearing file input

- **Creatives Management**
  - DELETE `/api/creatives/[id]` endpoint for database persistence
  - Org-scoped deletion (can only delete own org's creatives)
  - Remove button updates both UI and database

- **Settings Page**
  - Increased max-width from 2xl to 4xl for better content layout
  - Billing tab shows super admin controls even without subscription

### API Routes

- **`POST /api/creatives/generate`**
  - Generates AI creatives using Google Gemini
  - Accepts FormData with campaign parameters and context images
  - Returns array of generated creatives with image URLs and ad copy
  - Supports 1-4 variations per request
  - Uploads to DO Spaces if configured, falls back to base64

- **`GET /api/creatives`**
  - Fetches all creatives for current org
  - Returns last 100 creatives sorted by creation date (desc)
  - Includes all generation parameters and product image URLs

- **`DELETE /api/creatives/[id]`**
  - Deletes creative by ID
  - Org-scoped (only deletes if belongs to current org)
  - Returns 404 if not found or not owned

- **`GET /api/subscription`**
  - Returns current org's subscription details
  - Used for plan badge display

- **`POST /api/billing/create-portal-session`**
  - Creates Stripe Customer Portal session
  - Redirects user to Stripe for subscription management

### Database Schema

- **`creatives` table**
  - Stores all AI-generated creatives
  - Fields: `orgId`, `userId`, `prompt`, `imageUrl`, `campaignGoal`, `targetCta`, `adAngle`, `customPrompt`, `brandGuidelines`, `productId`, `productImageUrls` (JSON), `headline`, `primaryText`, `description`, `callToAction`, `createdAt`

- **`product_images` table**
  - Stores Shopify product images
  - Fields: `productId`, `imageUrl`, `position`, `createdAt`
  - Up to 10 images per product

- **`subscriptions` table**
  - Tracks organization subscriptions
  - Fields: `orgId`, `tier`, `stripeCustomerId`, `stripeSubscriptionId`, `status`, `currentPeriodEnd`

### Setup Requirements

**Google AI API:**
1. Sign up at https://aistudio.google.com/
2. Get API key from https://aistudio.google.com/apikey
3. Add to environment: `GOOGLE_AI_API_KEY=your-key`

**DigitalOcean Spaces (optional):**
1. Create Space at https://cloud.digitalocean.com/spaces
2. Generate keys at https://cloud.digitalocean.com/account/api/spaces
3. Add to environment:
   - `DO_SPACES_REGION=nyc3` (or your region)
   - `DO_SPACES_BUCKET=your-bucket-name`
   - `DO_SPACES_KEY=your-access-key`
   - `DO_SPACES_SECRET=your-secret-key`
   - `DO_SPACES_ENDPOINT=https://nyc3.digitaloceanspaces.com`
   - `DO_SPACES_CDN_ENDPOINT=https://your-cdn-url.com` (optional)

**Stripe:**
1. Create Stripe account and get API keys
2. Add to environment: `STRIPE_SECRET_KEY`, `STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOK_SECRET`
3. Configure product IDs for subscription tiers

### Technical Notes

- **Next.js 15 Compatibility** - Updated API routes to use async params (`{ params: Promise<{ id: string }> }`)
- **Google Gemini Models**
  - Image generation: `gemini-3-pro-image-preview`
  - Text/ad copy: `gemini-1.5-pro`
- **Safety Settings** - Medium/high thresholds for all harm categories, strictest for adult content
- **Image Format** - All generated images stored as PNG
- **Character Limits** - Headlines 25-40 chars, primary text 100-125 chars (optimized for Facebook/Instagram)
- **Non-blocking Generation** - Ad copy failures don't prevent image generation success
- **Org-Scoped** - All creatives, deletions, and subscriptions properly scoped to organization

### Migration Notes

- Migration `0008_add_product_images.sql` - Creates `product_images` table
- Migration `0009_add_creatives_table.sql` - Creates `creatives` table with all fields
- Migration `0010_add_subscriptions.sql` - Creates `subscriptions` table and Stripe integration
- Shopify webhook automatically backfills product images on product updates
