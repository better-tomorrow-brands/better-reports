# Multi-Tenancy (v1.1.1)

Adds full multi-tenancy so a single deployment serves multiple organizations. Each org has isolated data, settings, and user memberships. Existing data is backfilled to org 1 during migration.

## How It Works

1. An `organizations` table stores each tenant (id, name, slug)
2. A `user_organizations` junction table maps users to orgs with per-org roles (admin/user)
3. Every data table gains an `org_id` NOT NULL foreign key to `organizations`
4. The `settings` table switches from single-column PK (`key`) to composite PK (`org_id`, `key`)
5. Client-side: `OrgContext` provides the current org and an `apiFetch()` wrapper that injects the `X-Org-Id` header on every request
6. Server-side: `requireOrgFromRequest()` reads `X-Org-Id`, verifies the user is authenticated via Clerk, and checks org membership
7. Webhooks (Shopify) use `getOrgIdByStoreDomain()` to route incoming requests to the correct org
8. An org switcher in the sidebar lets users switch between their orgs

## Role Hierarchy

Two separate role systems coexist:

### Platform Roles (stored in `users.role`)

| Role | Access |
|---|---|
| `super_admin` | All orgs, all API routes, org CRUD, member management |
| `admin` | Standard authenticated access |
| `user` | Standard authenticated access |

### Org Roles (stored in `user_organizations.role`)

| Role | Access |
|---|---|
| `admin` | Full access within the org |
| `user` | Standard access within the org |

`super_admin` bypasses the org membership check entirely — they can access any org without needing a `user_organizations` row.

## Data Flow

### Client-Side (Browser)

```
OrgProvider (React Context)
    │
    ├── Fetches GET /api/organizations on mount
    │   → Returns orgs the user belongs to (super_admin sees all)
    │
    ├── Stores currentOrg in state + localStorage ("better-reports:org-id")
    │
    └── apiFetch(url, options)
            → fetch(url, { ...options, headers: { "X-Org-Id": currentOrg.id } })
```

### Server-Side (API Routes)

```
Incoming request with X-Org-Id header
        │
        ▼
requireOrgFromRequest(request)
        │
        ├── Parses X-Org-Id header → orgId
        ├── Calls auth() → userId (Clerk)
        ├── Looks up users.role
        │   ├── super_admin → access granted (skip membership check)
        │   └── admin/user → checks user_organizations for (userId, orgId)
        │
        └── Returns { userId, orgId } or throws OrgAuthError (401/403)
```

### Webhook Routing (Shopify)

```
Incoming webhook with X-Shopify-Shop-Domain header
        │
        ▼
getOrgIdByStoreDomain(shopDomain)
        │
        ├── Queries all settings rows where key = "shopify"
        ├── Decrypts each value (AES-256-GCM)
        ├── Compares store_domain to the incoming shop domain
        └── Returns matching orgId or null
```

## Organizations API

| Method | Endpoint | Access | Description |
|---|---|---|---|
| `GET` | `/api/organizations` | Authenticated | List user's orgs (super_admin sees all) |
| `POST` | `/api/organizations` | super_admin | Create new org (name + slug) |
| `PATCH` | `/api/organizations/[id]` | super_admin | Rename org (auto-generates slug) |
| `DELETE` | `/api/organizations/[id]` | super_admin | Delete org (cascades settings + memberships) |
| `GET` | `/api/organizations/[id]/members` | super_admin | List org members |
| `POST` | `/api/organizations/[id]/members` | super_admin | Add member by email (user must exist) |
| `PATCH` | `/api/organizations/[id]/members` | super_admin | Change member's org role |
| `DELETE` | `/api/organizations/[id]/members?userId=...` | super_admin | Remove member |

New users who sign in for the first time are auto-created in the `users` table and, if `DEFAULT_ORG_ID` is set, auto-added to that org with the `user` role.

## Org Switcher

Located in `src/components/Sidebar.tsx`. Shows when the user belongs to 1+ orgs. Displays the current org name with a dropdown to switch. Selection is persisted to `localStorage` under the key `better-reports:org-id` and restored on page load.

When collapsed, the sidebar shows a `Building2` icon instead of the full org name.

## Database Schema

### `organizations` table

| Column | Type | Details |
|---|---|---|
| `id` | serial | Primary key |
| `name` | text | Display name (NOT NULL) |
| `slug` | text | URL-safe identifier (NOT NULL, UNIQUE) |
| `created_at` | timestamptz | Default `now()` |

### `user_organizations` table

| Column | Type | Details |
|---|---|---|
| `id` | serial | Primary key |
| `user_id` | text | FK → `users.id` (ON DELETE CASCADE) |
| `org_id` | integer | FK → `organizations.id` (ON DELETE CASCADE) |
| `role` | text | `admin` or `user` (default: `user`) |
| `created_at` | timestamptz | Default `now()` |

**Unique index:** `(user_id, org_id)`

### `settings` table (updated)

| Column | Type | Details |
|---|---|---|
| `org_id` | integer | FK → `organizations.id` (ON DELETE CASCADE) |
| `key` | text | Setting key |
| `value` | text | AES-256-GCM encrypted JSON |
| `updated_at` | timestamptz | Default `now()` |

**Primary key:** `(org_id, key)` — replaces old single-column PK on `key`.

### Tables with `org_id` added (12 total)

| Table | Org-Scoped Unique Index |
|---|---|
| `amazon_financial_events` | `(org_id, transaction_id)` |
| `amazon_sales_traffic` | `(org_id, date, child_asin)` |
| `campaigns_fcb` | — |
| `campaigns_wa` | — |
| `customers` | `(org_id, email)` |
| `facebook_ads` | `(org_id, date, campaign, adset, ad)` |
| `inventory_snapshots` | `(org_id, sku, date)` |
| `orders` | `(org_id, shopify_id)` |
| `posthog_analytics` | `(org_id, date)` |
| `products` | `(org_id, sku)` |
| `settings` | PK `(org_id, key)` |
| `sync_logs` | — |

## Migration Strategy

Migration `0012_volatile_jetstream.sql` performs a 12-step zero-downtime migration:

1. **Create** `organizations` table
2. **Seed** initial org (id=1, name="DooGood", slug="doogood")
3. **Create** `user_organizations` junction table
4. **Seed** user_organizations — all existing users join org 1 (admin/super_admin users get org role `admin`)
5. **Drop** old single-column unique constraints (replaced by org-scoped ones)
6. **Drop** old unique indexes
7. **Add** `org_id` as **NULLABLE** to all 12 data tables
8. **Backfill** all existing rows to org_id = 1
9. **Enforce** NOT NULL on `org_id` for all tables
10. **Fix** settings PK: drop old `(key)`, add composite `(org_id, key)`
11. **Add** foreign key constraints (all data tables → organizations)
12. **Create** new org-scoped unique indexes

## Environment Variables

| Variable | Purpose |
|---|---|
| `DEFAULT_ORG_ID` | Auto-assign new users to this org on first sign-in |

## Key Files

| File | Purpose |
|---|---|
| `src/lib/db/schema.ts` | Drizzle schema — `organizations`, `userOrganizations`, all tables with `orgId` |
| `src/contexts/OrgContext.tsx` | React context — `OrgProvider`, `useOrg()`, `apiFetch()` |
| `src/lib/org-auth.ts` | `requireOrgAccess()`, `requireOrgFromRequest()`, `OrgAuthError` |
| `src/lib/settings.ts` | `getOrgIdByStoreDomain()`, org-scoped settings read/write |
| `src/components/Sidebar.tsx` | Org switcher dropdown in sidebar |
| `src/app/api/organizations/route.ts` | List + create orgs |
| `src/app/api/organizations/[id]/route.ts` | Rename + delete org (super_admin) |
| `src/app/api/organizations/[id]/members/route.ts` | Member CRUD (super_admin) |
| `drizzle/0012_volatile_jetstream.sql` | Multi-tenancy migration |
